<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Portfolio Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--danger:#ef4444;--border:#1f2937}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:#1f2937;color:#fff;border:1px solid var(--border);cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn:hover{filter:brightness(1.1)}
    .title{font-size:20px;font-weight:700;margin:0 0 8px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;padding:10px 8px;border-bottom:1px solid var(--border)}
    th{color:var(--muted);font-weight:600}
    .chip{display:inline-block;padding:2px 8px;border-radius:12px;border:1px solid var(--border);background:#0b1220;margin:0 6px 6px 0}
    .right{display:flex;gap:10px;align-items:center}
    a.link{color:#9dd7ff;text-decoration:none}
    a.link:hover{text-decoration:underline}
  </style>
</head>
<body>
<div id="topnav"></div>
<script src="/ui/nav.js"></script>
<div class="wrap">
  <h1 style="margin:0 0 12px;">üß∫ Portfolio Editor</h1>
  <p class="muted" style="margin:0 0 16px;">–í—ã–±–∏—Ä–∞–π—Ç–µ —Ç–∏–∫–µ—Ä—ã, —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø–∞—á–∫–æ–π —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã <code>/positions</code> –∏ <code>/positions/bulk_json</code>.</p>

  <div class="card" style="margin-bottom:16px;">
    <div class="row">
      <div style="flex:1 1 360px;">
        <label class="muted">User ID</label>
        <input id="userId" class="input" placeholder="UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
      </div>
      <div class="right">
        <button id="loadBtn" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏</button>
        <a id="toVal" class="link" href="#" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –æ—Ü–µ–Ω–∫–∏ (UI)</a>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom:16px;">
    <div class="title">–ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è</div>
    <div class="row">
      <div style="flex:1 1 200px;">
        <label class="muted">–¢–∏–∫–µ—Ä</label>
        <input id="symbol" class="input" list="symList" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: AAPL, MSFT, TSLA" />
        <datalist id="symList">
          <option value="AAPL"></option><option value="MSFT"></option><option value="TSLA"></option>
          <option value="NVDA"></option><option value="AMZN"></option><option value="GOOGL"></option>
          <option value="META"></option><option value="BRK.B"></option><option value="SPY"></option>
          <option value="QQQ"></option><option value="GLD"></option><option value="BTC-USD"></option>
        </datalist>
      </div>
      <div style="flex:1 1 160px;">
        <label class="muted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
        <input id="qty" class="input" type="number" step="0.00000001" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 10" />
      </div>
      <div style="flex:1 1 160px;">
        <label class="muted">–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ (–æ–ø—Ü.)</label>
        <input id="price" class="input" type="number" step="0.00000001" min="0" placeholder="–Ω–∞–ø—Ä. 150.25" />
      </div>
      <div style="flex:1 1 180px;">
        <label class="muted">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏ (–æ–ø—Ü.)</label>
        <input id="date" class="input" type="date" />
      </div>
      <div style="flex:1 1 120px;">
        <label class="muted">–í–∞–ª—é—Ç–∞</label>
        <input id="ccy" class="input" value="USD" />
      </div>
      <div style="flex:1 1 160px;">
        <label class="muted">–°—á—ë—Ç (–æ–ø—Ü.)</label>
        <input id="account" class="input" placeholder="main / broker1" />
      </div>
      <div>
        <button id="addBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å –≤ —á–µ—Ä–Ω–æ–≤–∏–∫</button>
      </div>
    </div>

    <div style="margin-top:12px;" class="muted">–ß–µ—Ä–Ω–æ–≤–∏–∫ (–±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ø–∞—á–∫–æ–π):</div>
    <div id="draftChips" style="margin-top:8px;"></div>
    <div style="margin-top:8px;">
      <button id="saveBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ (bulk)</button>
      <span id="status" class="muted" style="margin-left:10px;"></span>
    </div>
  </div>

  <div class="card">
    <div class="title">–¢–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr><th>–¢–∏–∫–µ—Ä</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th><th>–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏</th><th>–î–∞—Ç–∞</th><th>–í–∞–ª—é—Ç–∞</th><th>–°—á—ë—Ç</th></tr>
        </thead>
        <tbody id="tblBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $=(q)=>document.querySelector(q);
let draft=[];

function toMoney(x){ return (x==null||x==="")?"":Number(x).toLocaleString("en-US",{maximumFractionDigits:8}); }
function getParam(name){ const u=new URL(location.href); return u.searchParams.get(name)||""; }

function renderDraft(){
  const box=$("#draftChips"); box.innerHTML="";
  if(draft.length===0){ box.innerHTML=`<span class="muted">–ü—É—Å—Ç–æ</span>`; return; }
  draft.forEach((p,idx)=>{
    const el=document.createElement("span");
    el.className="chip";
    el.innerHTML=`<b>${p.symbol}</b> ‚Ä¢ qty: ${p.quantity}${p.buy_price?` @ ${p.buy_price}`:""}${p.buy_date?` on ${p.buy_date}`:""}${p.account?` ‚Ä¢ ${p.account}`:""}
      <button data-i="${idx}" style="margin-left:8px;cursor:pointer;background:none;border:none;color:#ddd;">√ó</button>`;
    el.querySelector("button").addEventListener("click",(e)=>{ draft.splice(Number(e.target.dataset.i),1); renderDraft(); });
    box.appendChild(el);
  });
}

function addToDraft(){
  const s=$("#symbol").value.trim();
  const q=$("#qty").value.trim();
  if(!s){ alert("–£–∫–∞–∂–∏—Ç–µ —Ç–∏–∫–µ—Ä"); return; }
  if(!q || Number(q)<=0){ alert("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ > 0"); return; }
  draft.push({
    symbol:s,
    quantity:q, // —Å—Ç—Ä–æ–∫–æ–π ‚Äî —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Decimal
    buy_price:$("#price").value?$("#price").value:null,
    buy_date:$("#date").value?$("#date").value:null,
    currency:$("#ccy").value||"USD",
    account:$("#account").value||null
  });
  renderDraft();
  $("#qty").value=""; $("#price").value=""; $("#date").value="";
}

async function fetchJSON(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error(`${r.status} ${await r.text()}`);
  return r.json();
}

async function listPositions(){
  const uid=$("#userId").value.trim();
  if(!uid){ alert("–í–≤–µ–¥–∏—Ç–µ User ID"); return; }
  const tb=$("#tblBody"); tb.innerHTML=`<tr><td colspan="6" class="muted">–ó–∞–≥—Ä—É–∂–∞—é...</td></tr>`;

  // 1) –ø—Ä–æ–±—É–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é ?user_id=
  let rows=null;
  try{ rows = await fetchJSON(`/positions?user_id=${encodeURIComponent(uid)}`); }
  catch(_){ /* fallback –Ω–∏–∂–µ */ }

  // 2) –µ—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ ‚Äî —Ç—è–Ω–µ–º –≤—Å–µ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ user_id –∫–ª–∏–µ–Ω—Ç—Å–∫–∏
  if(!Array.isArray(rows)){
    rows = await fetchJSON(`/positions`);
    rows = rows.filter(r=>String(r.user_id).toLowerCase()===uid.toLowerCase());
  }

  tb.innerHTML="";
  if(!rows.length){ tb.innerHTML=`<tr><td colspan="6" class="muted">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</td></tr>`; return; }
  for(const r of rows){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.symbol}</td><td>${toMoney(r.quantity)}</td><td>${toMoney(r.buy_price)}</td><td>${r.buy_date??""}</td><td>${r.currency}</td><td>${r.account??""}</td>`;
    tb.appendChild(tr);
  }
}

async function saveDraft(){
  const uid=$("#userId").value.trim();
  if(!uid){ alert("–í–≤–µ–¥–∏—Ç–µ User ID"); return; }
  if(draft.length===0){ alert("–ß–µ—Ä–Ω–æ–≤–∏–∫ –ø—É—Å—Ç"); return; }
  $("#saveBtn").disabled=true; $("#status").textContent="–°–æ—Ö—Ä–∞–Ω—è—é...";

  // –ü—Ä–æ–±—É–µ–º –¥–≤–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ä—É—á–∫–∏ /positions/bulk_json:
  // A) ?user_id=... –∏ body = [PositionCreate...]
  // B) body = { user_id, items: [PositionCreate...] }
  let ok=false, resp=null, errText="";
  try{
    const r=await fetch(`/positions/bulk_json?user_id=${encodeURIComponent(uid)}`,{
      method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(draft)
    });
    resp=await r.json();
    if(!r.ok) throw new Error(typeof resp==="string"?resp:JSON.stringify(resp));
    ok=true;
  }catch(e){ errText=String(e); }

  if(!ok){
    try{
      const r=await fetch(`/positions/bulk_json`,{
        method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ user_id:uid, items:draft })
      });
      resp=await r.json();
      if(!r.ok) throw new Error(typeof resp==="string"?resp:JSON.stringify(resp));
      ok=true;
    }catch(e){ errText += " | "+String(e); }
  }

  if(ok){
    $("#status").textContent=`OK: inserted ${resp.inserted??resp.created??0}, updated ${resp.updated??0}, failed ${resp.failed??0}`;
    draft=[]; renderDraft();
    await listPositions();
  }else{
    $("#status").textContent=`–û—à–∏–±–∫–∞: ${errText}`;
  }
  $("#saveBtn").disabled=false;
}

// External symbols typeahead functionality
async function fillPopularExternal(){
  try{
    const res = await fetch('/symbols/external/popular');
    if(!res.ok) return;
    const arr = await res.json();
    const dl = document.getElementById('symList'); dl.innerHTML = '';
    arr.forEach(s => {
      const o = document.createElement('option'); o.value = s; dl.appendChild(o);
    });
  }catch{}
}

let searchTimer = null;
async function searchSymbolsExternal(term){
  term = (term||'').trim();
  if(term.length < 1) return;
  try{
    const res = await fetch(`/symbols/external/search?q=${encodeURIComponent(term)}`);
    if(!res.ok) return;
    const arr = await res.json();
    const dl = document.getElementById('symList'); dl.innerHTML = '';
    arr.forEach(s => {
      const o = document.createElement('option'); o.value = s; dl.appendChild(o);
    });
  }catch{}
}

document.getElementById("addBtn").addEventListener("click", addToDraft);
document.getElementById("saveBtn").addEventListener("click", saveDraft);
document.getElementById("loadBtn").addEventListener("click", listPositions);

window.addEventListener("DOMContentLoaded", ()=>{
  renderNav("editor", { userInputId: "userId" });
  
  fillPopularExternal();

  const symInput = document.getElementById('symbol');
  symInput.addEventListener('input', (e)=>{
    const v = e.target.value;
    clearTimeout(searchTimer);
    searchTimer = setTimeout(()=>searchSymbolsExternal(v), 180);
  });

  const uid=getParam("user_id"); if(uid){ $("#userId").value=uid; }
  $("#toVal").href = `/ui/valuations.html?user_id=${encodeURIComponent($("#userId").value||uid||"")}`;
  $("#userId").addEventListener("input", ()=>{ $("#toVal").href = `/ui/valuations.html?user_id=${encodeURIComponent($("#userId").value)}`; });
  if(uid){ listPositions().catch(()=>{}); }
});
</script>
</body>
</html>
